name: Branch Protection Setup

on:
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [main]
    paths:
      - '.github/workflows/branch-protection.yml'

permissions:
  contents: read

jobs:
  setup-branch-protection:
    name: Setup Branch Protection Rules
    runs-on: ubuntu-latest
    if: github.repository_owner != 'github'  # Don't run on forks
    steps:
      - uses: actions/checkout@v4

      - name: Setup Branch Protection for main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/branches/main/protection \
            --method PUT \
            --field required_status_checks='{"strict":true,"contexts":["Backend Quality","Backend Tests","Frontend Quality","Build Docker Images"]}' \
            --field enforce_admins=true \
            --field required_pull_request_reviews='{"dismiss_stale_reviews":true,"require_code_owner_reviews":true,"required_approving_review_count":2}' \
            --field restrictions=null

      - name: Setup Branch Protection for qa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/branches/qa/protection \
            --method PUT \
            --field required_status_checks='{"strict":true,"contexts":["Backend Quality","Backend Tests","Frontend Quality","Build Docker Images"]}' \
            --field enforce_admins=true \
            --field required_pull_request_reviews='{"dismiss_stale_reviews":true,"require_code_owner_reviews":true,"required_approving_review_count":1}' \
            --field restrictions=null || echo "QA branch may not exist yet"

      - name: Setup Branch Protection for dev
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/branches/dev/protection \
            --method PUT \
            --field required_status_checks='{"strict":true,"contexts":["Backend Quality","Backend Tests","Frontend Quality","Build Docker Images"]}' \
            --field enforce_admins=true \
            --field required_pull_request_reviews='{"dismiss_stale_reviews":true,"require_code_owner_reviews":false,"required_approving_review_count":1}' \
            --field restrictions=null || echo "Dev branch may not exist yet"

      - name: Setup Branch Protection for develop
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/branches/develop/protection \
            --method PUT \
            --field required_status_checks='{"strict":true,"contexts":["Backend Quality","Backend Tests","Frontend Quality","Build Docker Images"]}' \
            --field enforce_admins=false \
            --field required_pull_request_reviews='{"dismiss_stale_reviews":false,"require_code_owner_reviews":false,"required_approving_review_count":1}' \
            --field restrictions=null || echo "Develop branch may not exist yet"
